<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Device Decomposition Visualization</title>
    <script src="https://cdn.plot.ly/plotly-3.3.0.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        #sidebar {
            width: 300px;
            min-width: 300px;
            flex-shrink: 0;
            background-color: #f5f5f5;
            padding: 20px;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        #main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        #plot {
            flex-grow: 1;
            width: 100%;
            height: 100%;
        }
        .control-group {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .control-group h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 14px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .slider-container {
            margin-bottom: 10px;
        }
        .slider-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 4px;
            color: #555;
        }
        input[type=range] {
            width: 100%;
        }
        #stats {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-size: 12px;
            pointer-events: none;
            z-index: 100;
        }
        .stat-line {
            margin-bottom: 4px;
        }
        .stat-label {
            font-weight: bold;
        }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="control-group">
        <h3>Device Dimensions (Grid of GPUs)</h3>
        <div class="slider-container">
            <div class="slider-label"><span>nx (Dev X)</span><span id="val-nx">8</span></div>
            <input type="range" id="input-nx" min="1" max="8" step="1" value="8">
        </div>
        <div class="slider-container">
            <div class="slider-label"><span>ny (Dev Y)</span><span id="val-ny">8</span></div>
            <input type="range" id="input-ny" min="1" max="8" step="1" value="8">
        </div>
        <div class="slider-container">
            <div class="slider-label"><span>nz (Dev Z)</span><span id="val-nz">8</span></div>
            <input type="range" id="input-nz" min="1" max="8" step="1" value="8">
        </div>
    </div>

    <div class="control-group">
        <h3>Per-Device Domain Size</h3>
        <div class="slider-container">
            <div class="slider-label"><span>Bx</span><span id="val-Bx">256</span></div>
            <input type="range" id="input-Bx" min="32" max="1024" step="32" value="256">
        </div>
        <div class="slider-container">
            <div class="slider-label"><span>By</span><span id="val-By">256</span></div>
            <input type="range" id="input-By" min="32" max="1024" step="32" value="256">
        </div>
        <div class="slider-container">
            <div class="slider-label"><span>Bz</span><span id="val-Bz">256</span></div>
            <input type="range" id="input-Bz" min="32" max="1024" step="32" value="256">
        </div>
    </div>
    
    <div style="font-size: 11px; color: #666; line-height: 1.4;">
        <p><strong>Legend:</strong></p>
        <p>Each box represents the domain handled by a single GPU.</p>
        <p>Hover to see coordinate ranges.</p>
    </div>
</div>

<div id="main">
    <div id="stats">
        <div class="stat-line"><span class="stat-label">Total GPUs:</span> <span id="stat-gpus">0</span></div>
        <div class="stat-line"><span class="stat-label">Global Domain (N):</span> <span id="stat-N">[0, 0, 0]</span></div>
    </div>
    <div id="plot"></div>
</div>

<script>
    // Helper functions
    function getCubeWireframe(x0, y0, z0, x1, y1, z1) {
        const x = [x0, x1, x1, x0, x0, null, x0, x1, x1, x0, x0, null, x0, x0, null, x1, x1, null, x1, x1, null, x0, x0];
        const y = [y0, y0, y1, y1, y0, null, y0, y0, y1, y1, y0, null, y0, y0, null, y0, y0, null, y1, y1, null, y1, y1];
        const z = [z0, z0, z0, z0, z0, null, z1, z1, z1, z1, z1, null, z0, z1, null, z0, z1, null, z0, z1, null, z0, z1];
        return {x, y, z};
    }

    function getCubeMesh(x0, y0, z0, x1, y1, z1) {
        const x = [x0, x1, x1, x0, x0, x1, x1, x0];
        const y = [y0, y0, y1, y1, y0, y0, y1, y1];
        const z = [z0, z0, z0, z0, z1, z1, z1, z1];
        const i = [7, 0, 0, 0, 4, 4, 6, 6, 4, 0, 3, 2];
        const j = [3, 4, 1, 2, 5, 6, 5, 2, 0, 1, 6, 3];
        const k = [0, 7, 2, 3, 6, 7, 1, 1, 5, 5, 7, 6];
        return {x, y, z, i, j, k};
    }

    // State
    const state = {
        nx: 2, ny: 2, nz: 1,
        Bx: 256, By: 256, Bz: 256
    };

    // Elements
    const inputs = {
        nx: document.getElementById('input-nx'),
        ny: document.getElementById('input-ny'),
        nz: document.getElementById('input-nz'),
        Bx: document.getElementById('input-Bx'),
        By: document.getElementById('input-By'),
        Bz: document.getElementById('input-Bz')
    };
    
    const labels = {
        nx: document.getElementById('val-nx'),
        ny: document.getElementById('val-ny'),
        nz: document.getElementById('val-nz'),
        Bx: document.getElementById('val-Bx'),
        By: document.getElementById('val-By'),
        Bz: document.getElementById('val-Bz')
    };

    const stats = {
        gpus: document.getElementById('stat-gpus'),
        N: document.getElementById('stat-N')
    };

    // Update function
    function update() {
        // Read inputs
        for (const key in inputs) {
            state[key] = parseInt(inputs[key].value);
            labels[key].textContent = state[key];
        }

        const { nx, ny, nz, Bx, By, Bz } = state;
        const N = [nx * Bx, ny * By, nz * Bz];
        const totalGPUs = nx * ny * nz;

        // Update Stats
        stats.gpus.textContent = totalGPUs;
        stats.N.textContent = `[${N.join(', ')}]`;

        // Generate Traces
        // We will merge all wireframes into one trace, all meshes into one trace, and all text into one trace for performance
        const wireX = [], wireY = [], wireZ = [];
        const meshX = [], meshY = [], meshZ = [];
        const meshI = [], meshJ = [], meshK = [];
        const textX = [], textY = [], textZ = [], textVal = [];
        const hoverText = []; // For mesh hover

        let meshOffset = 0;

        for (let z = 0; z < nz; z++) {
            for (let y = 0; y < ny; y++) {
                for (let x = 0; x < nx; x++) {
                    const gpu_id = x + y * nx + z * nx * ny;

                    // Coords
                    const x0 = x * Bx;
                    const y0 = y * By;
                    const z0 = z * Bz;
                    const x1 = x0 + Bx;
                    const y1 = y0 + By;
                    const z1 = z0 + Bz;

                    // Wireframe
                    const w = getCubeWireframe(x0, y0, z0, x1, y1, z1);
                    wireX.push(...w.x, null);
                    wireY.push(...w.y, null);
                    wireZ.push(...w.z, null);

                    // Mesh
                    const m = getCubeMesh(x0, y0, z0, x1, y1, z1);
                    meshX.push(...m.x);
                    meshY.push(...m.y);
                    meshZ.push(...m.z);
                    
                    // Adjust indices for merged mesh
                    meshI.push(...m.i.map(idx => idx + meshOffset));
                    meshJ.push(...m.j.map(idx => idx + meshOffset));
                    meshK.push(...m.k.map(idx => idx + meshOffset));
                    meshOffset += m.x.length;

                    // Hover text for each vertex of the mesh (Plotly mesh3d hover is per vertex or face)
                    // We'll use 'text' attribute on mesh3d which can be an array matching vertices
                    const info = `GPU ${gpu_id}<br>Range: [${x0}:${x1}, ${y0}:${y1}, ${z0}:${z1}]`;
                    for(let k=0; k<m.x.length; k++) hoverText.push(info);

                    // Center Label
                    textX.push((x0 + x1) / 2);
                    textY.push((y0 + y1) / 2);
                    textZ.push((z0 + z1) / 2);
                    textVal.push(`GPU ${gpu_id}`);
                }
            }
        }

        const traces = [
            {
                type: 'scatter3d',
                mode: 'lines',
                x: wireX, y: wireY, z: wireZ,
                line: { color: 'black', width: 4 },
                name: 'Boundaries',
                hoverinfo: 'skip'
            },
            {
                type: 'mesh3d',
                x: meshX, y: meshY, z: meshZ,
                i: meshI, j: meshJ, k: meshK,
                opacity: 0.1,
                color: 'blue',
                hoverinfo: 'text',
                text: hoverText
            },
            {
                type: 'scatter3d',
                mode: 'text',
                x: textX, y: textY, z: textZ,
                textposition: 'middle center',
                text: textVal,
                textfont: { color: 'black', size: 12 },
            }
        ];

        const layout = {
            scene: {
                xaxis: { title: 'X (Lattice Units)' },
                yaxis: { title: 'Y (Lattice Units)' },
                zaxis: { title: 'Z (Lattice Units)' },
                aspectmode: 'data'
            },
            margin: { l: 0, r: 0, b: 0, t: 0 },
            showlegend: false,
            uirevision: 'true' // Keep camera view
        };

        Plotly.react('plot', traces, layout);
    }

    // Initialize
    for (const key in inputs) {
        inputs[key].addEventListener('input', update);
    }
    
    // Initial render
    update();

    // Set default values
    document.getElementById('input-nx').value = 2;
    document.getElementById('input-ny').value = 2;
    document.getElementById('input-nz').value = 1;

    update();

    // Handle resize
    window.addEventListener('resize', () => {
        Plotly.Plots.resize('plot');
    });

</script>

</body>
</html>